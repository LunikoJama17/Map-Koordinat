<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Peta Multi Titik & Polyline (GeoJSON)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body class="bg-gray-100 flex flex-col items-center min-h-screen p-4">
  <div class="w-full max-w-3xl bg-white shadow-lg rounded-2xl p-6 space-y-4">
    <h1 class="text-2xl font-bold text-center mb-4">
      Peta Multi Titik (Polyline + GeoJSON)
    </h1>

    <!-- Input koordinat -->
    <div id="coordinate-inputs" class="space-y-4">
      <div class="coordinate-group flex items-start space-x-2">
        <div class="flex-1">
          <label class="block font-semibold mb-1">Koordinat 1</label>
          <textarea
            placeholder="Contoh: 2Â° 17' 98,507&quot; S 114Â° 1' 53,128&quot; E"
            class="w-full border border-gray-300 rounded-md p-2 focus:ring focus:ring-blue-300"
          ></textarea>
        </div>
        <button
          class="delete-btn bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-md mt-6"
          onclick="removeCoordinate(this)"
        >
          âœ•
        </button>
      </div>
    </div>

    <!-- Tombol -->
    <div class="flex flex-wrap gap-2 justify-between">
      <button
        id="addCoordinate"
        class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition"
      >
        Tambah Koordinat
      </button>
      <button
        id="markPoints"
        class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition"
      >
        Tandai Titik
      </button>
      <button
        id="downloadGeoJSON"
        class="bg-yellow-500 text-white px-4 py-2 rounded-md hover:bg-yellow-600 transition"
      >
        ðŸ’¾ Download GeoJSON
      </button>
    </div>
  </div>

  <!-- Peta -->
  <div id="map" class="w-full max-w-6xl h-[600px] md:h-[700px] mt-6 rounded-2xl shadow-lg"></div>

  <!-- Tabel Data Titik -->
  <div class="w-full max-w-6xl mt-6 bg-white rounded-xl shadow-lg p-4 overflow-x-auto">
    <h2 class="text-lg font-bold mb-3">Daftar Titik</h2>
    <table class="min-w-full text-sm text-left border border-gray-200">
      <thead class="bg-gray-100">
        <tr>
          <th class="py-2 px-3 border-b">#</th>
          <th class="py-2 px-3 border-b">Koordinat (DMS)</th>
          <th class="py-2 px-3 border-b">Koordinat (Desimal)</th>
          <th class="py-2 px-3 border-b">Mode</th>
          <th class="py-2 px-3 border-b">Waktu</th>
        </tr>
      </thead>
      <tbody id="pointsTableBody" class="divide-y"></tbody>
    </table>
  </div>

  <script>
    const map = L.map("map").setView([-2.5489, 118.0149], 5);

    // Layer dasar peta
    const baseLayers = {
      Default: L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "Â© OpenStreetMap",
      }),
      Gelap: L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
        maxZoom: 19,
        attribution: "Â© CartoDB",
      }),
      Satelit: L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
        { maxZoom: 19, attribution: "Â© Esri" }
      ),
    };

    let currentLayer = baseLayers["Default"].addTo(map);
    let currentMode = "Default";
    let markers = [];
    let polyline = null;

    // Mode kontrol
    const modeControl = L.control({ position: "topright" });
    modeControl.onAdd = () => {
      const div = L.DomUtil.create("div", "bg-white shadow-lg rounded-lg p-2 text-sm");
      div.innerHTML = `
        <label class='font-semibold'>Mode Peta:</label>
        <select id='mapMode' class='ml-2 border border-gray-300 rounded-md p-1'>
          <option value='Default'>Default</option>
          <option value='Gelap'>Gelap</option>
          <option value='Satelit'>Satelit</option>
        </select>`;
      return div;
    };
    modeControl.addTo(map);

    document.addEventListener("change", (e) => {
      if (e.target.id === "mapMode") {
        const selectedMode = e.target.value;
        if (currentLayer) map.removeLayer(currentLayer);
        currentLayer = baseLayers[selectedMode];
        currentLayer.addTo(map);
        currentMode = selectedMode;
      }
    });

    // Tambah dan hapus input koordinat
    const addCoordinate = document.getElementById("addCoordinate");
    const coordinateInputs = document.getElementById("coordinate-inputs");

    addCoordinate.addEventListener("click", () => {
      const count = coordinateInputs.children.length + 1;
      const div = document.createElement("div");
      div.classList.add("coordinate-group", "flex", "items-start", "space-x-2");
      div.innerHTML = `
        <div class="flex-1">
          <label class='block font-semibold mb-1'>Koordinat ${count}</label>
          <textarea placeholder='Contoh: 2Â° 17\' 45,672" S 114Â° 1\' 28,392" E'
            class='w-full border border-gray-300 rounded-md p-2 focus:ring focus:ring-blue-300'></textarea>
        </div>
        <button class="delete-btn bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-md mt-6" onclick="removeCoordinate(this)">âœ•</button>`;
      coordinateInputs.appendChild(div);
      updateLabels();
    });

    function removeCoordinate(btn) {
      const groups = document.querySelectorAll(".coordinate-group");
      if (groups.length > 1) {
        btn.parentElement.remove();
        updateLabels();
      } else {
        alert("Minimal satu koordinat harus ada!");
      }
    }

    function updateLabels() {
      document.querySelectorAll(".coordinate-group label").forEach((label, i) => {
        label.textContent = `Koordinat ${i + 1}`;
      });
    }

    // Fungsi konversi DMS ke desimal
    function dmsToDecimal(dmsStr) {
      const regex = /(\d+)[Â°\s]+(\d+)[â€²']\s*(\d+[,\.]?\d*)["â€³]?\s*([NSEW])/i;
      const match = dmsStr.match(regex);
      if (!match) return null;
      let deg = parseFloat(match[1]);
      let min = parseFloat(match[2]);
      let sec = parseFloat(match[3].replace(",", "."));
      let dir = match[4].toUpperCase();
      let dec = deg + min / 60 + sec / 3600;
      if (dir === "S" || dir === "W") dec *= -1;
      return dec;
    }

    // Parsing format input
    function parseCoordinate(coordStr) {
      const regex = /(\d+Â°\s*\d+'\s*[\d,\.]+"?\s*[NS])\s+(\d+Â°\s*\d+'\s*[\d,\.]+"?\s*[EW])/i;
      const match = coordStr.match(regex);
      if (!match) return null;
      const lat = dmsToDecimal(match[1]);
      const lon = dmsToDecimal(match[2]);
      return [lat, lon];
    }

    // Menandai titik & membuat polyline + tabel
    document.getElementById("markPoints").addEventListener("click", () => {
      const textareas = document.querySelectorAll("#coordinate-inputs textarea");
      let coords = [];
      markers.forEach((m) => map.removeLayer(m));
      if (polyline) map.removeLayer(polyline);
      markers = [];

      const tableBody = document.getElementById("pointsTableBody");
      tableBody.innerHTML = "";

      textareas.forEach((ta, i) => {
        const coord = parseCoordinate(ta.value);
        if (coord) {
          const marker = L.marker(coord, { draggable: true })
            .addTo(map)
            .bindPopup(`Titik ${i + 1}`);
          markers.push(marker);
          coords.push(coord);

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="py-2 px-3 border-b">${i + 1}</td>
            <td class="py-2 px-3 border-b">${ta.value}</td>
            <td class="py-2 px-3 border-b">${coord[0].toFixed(6)}, ${coord[1].toFixed(6)}</td>
            <td class="py-2 px-3 border-b">${currentMode}</td>
            <td class="py-2 px-3 border-b">${new Date().toLocaleString()}</td>`;
          tableBody.appendChild(tr);
        } else {
          alert(`Koordinat ${i + 1} tidak valid!`);
        }
      });

      if (coords.length > 1) {
        polyline = L.polyline(coords, { color: "blue" }).addTo(map);
      }
      if (coords.length > 0) map.fitBounds(L.latLngBounds(coords));
      updateGeoJSON(coords);
    });

    // Update dan download GeoJSON
    function updateGeoJSON(coords) {
      if (!coords || coords.length === 0) return;
      window.currentGeoJSON = {
        type: "FeatureCollection",
        features: [
          {
            type: "Feature",
            geometry: {
              type: "LineString",
              coordinates: coords.map((c) => [c[1], c[0]]),
            },
            properties: { created_at: new Date().toISOString(), mode: currentMode },
          },
        ],
      };
    }

    document.getElementById("downloadGeoJSON").addEventListener("click", () => {
      if (!window.currentGeoJSON) return alert("Belum ada titik yang ditandai!");
      const blob = new Blob([JSON.stringify(window.currentGeoJSON, null, 2)], {
        type: "application/geo+json",
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "multi-titik.geojson";
      a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
