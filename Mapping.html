<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Peta Multi Titik dengan Mode & GeoJSON</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body class="bg-gray-100 flex flex-col items-center min-h-screen p-4">
  <div class="w-full max-w-3xl bg-white shadow-lg rounded-2xl p-6 space-y-4">
    <h1 class="text-2xl font-bold text-center mb-4">Peta Multi Titik</h1>

    <div id="coordinate-inputs" class="space-y-4">
      <div class="coordinate-group flex flex-col">
        <div class="flex justify-between items-center mb-1">
          <label class="font-semibold">Koordinat 1</label>
          <button class="delete-btn text-red-500 hover:text-red-700 font-bold text-sm">‚ùå</button>
        </div>
        <textarea
          placeholder="Masukkan koordinat (contoh: 2¬∞ 17' 95,890&quot; S 119¬∞ 1' 53,797&quot; E)"
          class="w-full border border-gray-300 rounded-md p-2 focus:ring focus:ring-blue-300"></textarea>
      </div>
    </div>

    <div class="flex flex-wrap gap-2 justify-between">
      <button id="addCoordinate" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition">+ Tambah Koordinat</button>
      <button id="markPoints" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition">üìç Tandai Titik</button>
      <button id="downloadGeoJSON" class="bg-yellow-500 text-white px-4 py-2 rounded-md hover:bg-yellow-600 transition">üíæ Download GeoJSON</button>
    </div>
  </div>

  <div id="map" class="w-full max-w-6xl h-[600px] md:h-[700px] mt-6 rounded-2xl shadow-lg"></div>

  <script>
    // Inisialisasi peta
    const map = L.map('map').setView([-2.5489, 118.0149], 5);

    const defaultLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    const darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      maxZoom: 19,
      attribution: '¬© CartoDB Dark Matter'
    });

    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      maxZoom: 19,
      attribution: '¬© Esri World Imagery'
    });

    const baseLayers = {
      'Default': defaultLayer,
      'Gelap': darkLayer,
      'Satelit': satelliteLayer
    };

    let currentLayer = defaultLayer;
    let currentMode = 'Default';
    let markers = [];

    // Dropdown mode peta
    const modeControl = L.control({ position: 'topright' });
    modeControl.onAdd = function () {
      const div = L.DomUtil.create('div', 'bg-white shadow-lg rounded-lg p-2 text-sm');
      div.innerHTML = `
        <label class='font-semibold'>Mode Peta:</label>
        <select id='mapMode' class='ml-2 border border-gray-300 rounded-md p-1'>
          <option value='Default'>Default</option>
          <option value='Gelap'>Gelap</option>
          <option value='Satelit'>Satelit</option>
        </select>`;
      return div;
    };
    modeControl.addTo(map);

    // Label mode aktif
    const modeLabel = L.control({ position: 'bottomleft' });
    modeLabel.onAdd = function () {
      const div = L.DomUtil.create('div', 'bg-white bg-opacity-80 px-3 py-1 rounded-md text-sm font-semibold shadow-md');
      div.id = 'modeLabel';
      div.innerText = 'Mode: Default';
      return div;
    };
    modeLabel.addTo(map);

    setTimeout(() => map.invalidateSize(), 500);

    document.addEventListener('change', function (e) {
      if (e.target.id === 'mapMode') {
        const selectedMode = e.target.value;
        if (currentLayer) map.removeLayer(currentLayer);
        currentLayer = baseLayers[selectedMode];
        currentLayer.addTo(map);
        currentMode = selectedMode;
        document.getElementById('modeLabel').innerText = `Mode: ${selectedMode}`;
      }
    });

    // Tambah koordinat
    const addCoordinate = document.getElementById('addCoordinate');
    const coordinateInputs = document.getElementById('coordinate-inputs');

    function updateLabels() {
      const groups = coordinateInputs.querySelectorAll('.coordinate-group');
      groups.forEach((group, i) => {
        const label = group.querySelector('label');
        label.textContent = `Koordinat ${i + 1}`;
      });
    }

    addCoordinate.addEventListener('click', () => {
      const count = coordinateInputs.children.length + 1;
      const div = document.createElement('div');
      div.classList.add('coordinate-group', 'flex', 'flex-col');
      div.innerHTML = `
        <div class="flex justify-between items-center mb-1">
          <label class="font-semibold">Koordinat ${count}</label>
          <button class="delete-btn text-red-500 hover:text-red-700 font-bold text-sm">‚ùå</button>
        </div>
        <textarea
          placeholder="Masukkan koordinat (contoh: 2¬∞ 17' 95,890&quot; S 119¬∞ 1' 53,797&quot; E)"
          class="w-full border border-gray-300 rounded-md p-2 focus:ring focus:ring-blue-300"></textarea>`;
      coordinateInputs.appendChild(div);
    });

    // Hapus koordinat
    coordinateInputs.addEventListener('click', (e) => {
      if (e.target.classList.contains('delete-btn')) {
        const group = e.target.closest('.coordinate-group');
        if (group && coordinateInputs.children.length > 1) {
          group.remove();
          updateLabels();
        } else {
          alert('Minimal harus ada satu koordinat.');
        }
      }
    });

    // Konversi format DMS ke desimal
    function dmsToDecimal(dms, ref) {
      const parts = dms.match(/(\d+)¬∞\s*(\d+)'\s*([\d.,]+)\"/);
      if (!parts) return null;
      let deg = parseFloat(parts[1]);
      let min = parseFloat(parts[2]);
      let sec = parseFloat(parts[3].replace(',', '.'));
      let dec = deg + (min / 60) + (sec / 3600);
      if (ref === 'S' || ref === 'W') dec *= -1;
      return dec;
    }

    // Parsing teks koordinat
    function parseCoordinate(coord) {
      const regex = /(\d+¬∞\s*\d+'\s*[\d.,]+\"\s*[NS])\s+(\d+¬∞\s*\d+'\s*[\d.,]+\"\s*[EW])/;
      const match = coord.match(regex);
      if (!match) return null;
      const latPart = match[1];
      const lonPart = match[2];
      const latRef = latPart.includes('S') ? 'S' : 'N';
      const lonRef = lonPart.includes('W') ? 'W' : 'E';
      const lat = dmsToDecimal(latPart, latRef);
      const lon = dmsToDecimal(lonPart, lonRef);
      return [lat, lon];
    }

    // Tandai titik
    document.getElementById('markPoints').addEventListener('click', () => {
      markers = [];
      map.eachLayer((layer) => {
        if (layer instanceof L.Marker) map.removeLayer(layer);
      });

      const textareas = document.querySelectorAll('#coordinate-inputs textarea');
      let lastCoord = null;

      textareas.forEach((ta, i) => {
        const coord = parseCoordinate(ta.value);
        if (coord) {
          const marker = L.marker(coord).addTo(map).bindPopup(`Titik ${i + 1}`).openPopup();
          lastCoord = coord;
          markers.push({
            type: 'Feature',
            geometry: { type: 'Point', coordinates: [coord[1], coord[0]] },
            properties: {
              name: `Titik ${i + 1}`,
              timestamp: new Date().toISOString(),
              mode: currentMode
            }
          });
        }
      });

      if (lastCoord) map.flyTo(lastCoord, 10);
    });

    // Download GeoJSON
    document.getElementById('downloadGeoJSON').addEventListener('click', () => {
      if (markers.length === 0) return alert('Belum ada titik yang ditandai!');
      const geojson = { type: 'FeatureCollection', features: markers };
      const blob = new Blob([JSON.stringify(geojson, null, 2)], { type: 'application/geo+json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'titik-peta.geojson';
      a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
